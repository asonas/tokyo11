---
layout: page
title: 田中和明さんインタビュー
permalink: /interview/kaz0505/
---

{% include interview-head github='kaz0505' %}

5/10 Skypeにて伺いました（話し手：田中さん、聞き手：笹田）。

## mruby の話

__笹田__ お忙しいところ、ありがとうございます。今回は、[mruby/c](http://www.s-itoc.jp/activity/research/mruby/) の話をして頂ける、ということで。

__田中__ まず、mruby についてですが、Ruby のコンパイラと VM、インタプリタを切り離し、コンパイル済みバイナリはポータブルなので、色々なデバイスにデプロイしやすくなっています。そして、VM は十分小さいので、いろいろなデバイスへの移植が容易です。

__笹田__ なるほど。

__田中__ VM がハードウェアに依存するのですが、そのレイヤを mrubygems ということで抽象化することで、簡単に更新しやすくなっています。

__笹田__ `require` ができなくて、mrubygems で VM 生成時に埋め込まれる、ということですよね。

__田中__ 詳しくは、[http://mruby.org/](http://mruby.org/) を読むのが良いと思います。

__笹田__ 海外のカンファレンスでも、mruby についてよく聞かれます。例えば、どこまで進んでるの、とか、どうやって使うの、とか。

__田中__ 我々がよく言う話なのですが、VM のコードが1万行程度なので、それを読んでもらいたいと思っています。読んでもらえると、mruby の構造や、mruby をどのように拡張すれば良いか、ということがわかってもらえると思っています。ちょっと乱暴ではあるんですが。

__笹田__ ハードルはちょっと上がりますね。それくらいしないと、製品に使うのは難しい、ということですかね。

__田中__ そうですね。組込み製品を対象に考えているので、むしろそれをしやすいように、読みやすいようにコードを整理しています。ドキュメントは、まだちょっとこれから、というところです。

__笹田__ 組込みというのは、組込み機器への組込みと、アプリケーション組込みがあると思います。先ほどの話は組込み機器向けの話だと思うのですが、アプリケーション組込みというのはどうでしょうか。

__田中__ そちらのほうが、進んでいると思います。mrubygems で、いろんな機能が使えますので、不便がないと思います。

__笹田__ [RubyKaigi 2015 でも、mruby-cli の話](http://rubykaigi.org/2015/presentations/hone02_zzak)がありましたね。Ruby スクリプトを単体のバイナリにまとめる、あの機能がとても良い、という話をよく聞きます。あと海外では、英語のドキュメントがない、という話は聞きますね。

__田中__ 実は、まだ日本語のドキュメントも十分じゃないので、今後ですね。ただ、mrubygems の説明などは、英語で書かれていると思います。他のドキュメントは、[NPO 法人軽量 Rubyフォーラム](http://forum.mruby.org/)で進めて行ければと思っています。なかなかリソースが割けないのですが。

__笹田__ どれくらいの会社が参加されているんですか？

__田中__ 10 社くらいですね。今は、ドキュメントの前に、どのバージョンでどの mrubygems が動くか、などの検証を先に行なっています。

## mruby/c

__笹田__ 今、田中先生は mruby ではなく、mruby/c のほうに移られている。

__田中__ はい、今はそちらがメインですね。

__笹田__ ざっくりとしたイメージですが、mruby を更に小さくしたもの、なのですが、そういう理解でいいでしょうか。16 bit CPU でも動くと伺った気がします。

__田中__ はい。メモリ消費量を削減しています。まず、組込みクラスを減らしています。例えば、`String` や `Float` をオプショナルにしています。整数の計算だけしたい、というケースも結構あるので。

__笹田__ どれくらい削減されたんでしょうか。

__田中__ mruby は、実行時に 400 KB 程度必要です。mruby/c では 40 KB 程度で動かすことができます。

__田中__ なるほど。

__田中__ それから、GC をしません。その代わり、VM の起動を速くしています。VM が、1 メソッドで完結するようなイメージです。あるイベント、例えばスイッチが押されたら、そこで VM が起動し、あるメソッドを実行し、VM が終了する、というようなモデルを考えています。

__笹田__ つまり、VM 実行中は GC は行なわないが、VM のライフタイムが十分短いのでリソースを解放しなくても問題無い、ということでしょうか。

__田中__ そうです。もちろん、対応できない状況もありますが、なくても良い場合もあると思っています。

__笹田__ 手作業で解放する、みたいなことは出来るんでしょうか。

__田中__ そのために、VM を複数動かせるようにしています。つまり、リソース管理は VM 単位で行ない、長時間動くプログラムは、VM を作っては消して、というようにしています。

__笹田__ VM の起動時間はどうでしょうか。

__田中__ 研究でそのあたりを見ていまして、やはりオーバヘッドが大きいです。mruby/c は、それをほぼ 0 にしています。

__笹田__ オーバヘッドは、動的にメソッドを定義する、とか、そういうところですかね。

__田中__ はい。mruby/c では、そのあたりをデータ構造を工夫していて、ハッシュ表を索引付きの連結リストにしています．

__笹田__ あ、でも動的には作るんですね。コンパイル時に全部決めてしまう、という手もあると思うんですが。

__田中__ それも可能だと思うんですが、既存の mruby のバイトコードとの互換性がなくなってしまうので、まだやっていません。

__笹田__ そこ、互換性いるんでしょうか。

__田中__ コンパイラを弄るのが面倒で（笑）。

__笹田__ わかります！　CRuby でも、今そういうのをやりたいな、とは思っているのですが。CRuby だと使わないメソッド大量にあるので。

__田中__ 起動時間は、もう少し速くしたいですね。割り込み時に起動する、みたいにしたいので。現状は 100 ms 程度にしたいですね。やはり、動的にメソッドを定義するところがオーバヘッドなので、最終的にコンパイラを弄らないといけない気がします。

__笹田__ 凄く楽しそうですね。

__田中__ あと、mruby/c には組込みライブラリが足りないので、なんとかしたいと思っています。

__笹田__ mruby との互換性はどの程度なんでしょうか。

__田中__ よく使うメソッドはサポートしていますが、かなり不足しています。また、GC がないなど、違いがあって、mrubyのコードをそのまま持ってくるのは難しいですね。

__笹田__ なるほど。

__田中__ 起動の時間が短く、複数の VM が並行に動くこと、それからその裏の排他制御について、今回発表しようと思います。

__笹田__ 楽しみですね。本日は、お忙しいところ、ありがとうございました。
